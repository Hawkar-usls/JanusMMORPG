<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JANUS: PROTOCOL OMEGA (v10.0)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #050505; --panel: rgba(20,20,20,0.95); 
            --border: #333; --accent: #ffd700; --danger: #ff3333;
            --text-main: #e0e0e0; --text-dim: #777;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text-main); font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        
        canvas { display: block; width: 100vw; height: 100dvh; image-rendering: pixelated; }

        /* HUD LAYOUT */
        .hud-top { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; flex-direction: column; gap: 5px; width: 140px; }
        .stat-row { display: flex; align-items: center; justify-content: space-between; font-size: 10px; }
        .bar-track { flex: 1; height: 6px; background: #222; margin-left: 8px; border: 1px solid #444; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        
        .c-hp { background: #ff4444; } .c-food { background: #ffaa00; } 
        .c-water { background: #00aaff; } .c-temp { background: #ff7700; }

        .time-display { position: absolute; top: 10px; right: 10px; font-size: 12px; color: var(--accent); font-weight: bold; text-shadow: 0 0 10px var(--accent); z-index: 10; }

        /* BOTTOM DOCK */
        .dock { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: var(--panel); border: 1px solid var(--border); border-radius: 16px;
            padding: 8px 16px; display: flex; gap: 20px; z-index: 20; backdrop-filter: blur(5px);
        }
        .dock-btn { 
            font-size: 24px; cursor: pointer; transition: transform 0.1s; opacity: 0.8;
            position: relative;
        }
        .dock-btn:active { transform: scale(0.9); }
        .dock-btn.active { opacity: 1; color: var(--accent); }

        /* UNIVERSAL MODAL */
        .modal {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 450px; height: 70%; max-height: 600px;
            background: #111; border: 1px solid var(--border); border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9); z-index: 100;
            flex-direction: column; overflow: hidden;
        }
        .modal.open { display: flex; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translate(-50%, -40%); } to { opacity: 1; transform: translate(-50%, -50%); } }

        /* TABS */
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border); background: #1a1a1a; }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 11px; cursor: pointer; color: var(--text-dim); transition: 0.2s; }
        .tab.active { color: var(--accent); background: #222; border-bottom: 2px solid var(--accent); }

        /* CONTENT AREA */
        .modal-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* GRID & SLOTS */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; }
        .slot { 
            aspect-ratio: 1; background: #1e1e1e; border: 1px solid #333; border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 20px; position: relative; cursor: pointer; transition: 0.1s;
        }
        .slot:hover { background: #252525; }
        .slot.available { border-color: #5b5; background: rgba(0,50,0,0.2); }
        .slot.unavailable { opacity: 0.4; filter: grayscale(1); }
        .slot-count { position: absolute; bottom: 2px; right: 4px; font-size: 10px; color: #fff; font-weight: bold; }
        
        /* CRAFT ITEM INFO */
        .craft-info { display: flex; flex-direction: column; align-items: center; padding: 10px; border-top: 1px solid var(--border); background: #151515; }
        .res-cost { font-size: 10px; color: #aaa; margin: 5px 0; display: flex; gap: 8px; }
        .res-cost span.missing { color: var(--danger); }
        .res-cost span.ok { color: #5b5; }
        .btn-craft { 
            width: 100%; padding: 10px; background: var(--accent); color: #000; border: none; 
            border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 1;
        }
        .btn-craft:disabled { background: #333; color: #555; cursor: not-allowed; }

        /* TOASTS */
        .toast-container { position: absolute; top: 80px; left: 0; width: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 5px; z-index: 200; }
        .toast { background: rgba(0,0,0,0.8); color: var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 11px; border: 1px solid rgba(255,215,0,0.2); animation: fadeOut 2s forwards; }
        @keyframes fadeOut { 0%{opacity:1;transform:translateY(0)} 100%{opacity:0;transform:translateY(-20px)} }

        #error-log { display: none; position: absolute; top: 0; left: 0; background: red; color: white; padding: 10px; z-index: 9999; }
    </style>
</head>
<body>

    <div id="error-log"></div>
    <canvas id="game"></canvas>

    <div class="hud-top">
        <div class="stat-row">HP <div class="bar-track"><div class="bar-fill c-hp" id="hp-bar"></div></div></div>
        <div class="stat-row">EDA <div class="bar-track"><div class="bar-fill c-food" id="food-bar"></div></div></div>
        <div class="stat-row">H2O <div class="bar-track"><div class="bar-fill c-water" id="water-bar"></div></div></div>
        <div class="stat-row">TMP <div class="bar-track"><div class="bar-fill c-temp" id="temp-bar"></div></div></div>
    </div>
    
    <div class="time-display" id="clock">12:00</div>
    <div class="toast-container" id="toasts"></div>

    <div class="dock">
        <div class="dock-btn" onclick="UI.toggle('inv')">üéí</div>
        <div class="dock-btn" onclick="UI.toggle('craft')">üî®</div>
        <div class="dock-btn" onclick="Game.save(); UI.toast('System Saved')">üíæ</div>
    </div>

    <div class="modal" id="main-window">
        <div class="modal-tabs">
            <div class="tab" id="tab-inv" onclick="UI.switchTab('inv')">–†–Æ–ö–ó–ê–ö</div>
            <div class="tab" id="tab-craft" onclick="UI.switchTab('craft')">–°–û–ó–î–ê–ù–ò–ï</div>
            <div class="tab" onclick="UI.close()">–ó–ê–ö–†–´–¢–¨ [X]</div>
        </div>
        
        <div class="modal-content" id="view-inv" style="display:none">
            <div class="grid" id="inv-grid"></div>
            <div class="craft-info" id="inv-actions" style="display:none">
                <div id="selected-item-name" style="font-weight:bold; margin-bottom:5px;"></div>
                <button class="btn-craft" id="btn-use-item">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div class="modal-content" id="view-craft" style="display:none">
            <div class="grid" id="craft-grid"></div>
        </div>
        <div class="craft-info" id="craft-actions" style="display:none">
            <div id="craft-name" style="font-weight:bold; margin-bottom:5px;"></div>
            <div class="res-cost" id="craft-cost"></div>
            <button class="btn-craft" id="btn-do-craft">–°–û–ó–î–ê–¢–¨</button>
        </div>
    </div>

<script>
/** * JANUS ENGINE v10.0 
 * "Looking Forward"
 */

// --- DATA & CONFIG ---
const DB = {
    items: {
        'wood': { name: '–î–µ—Ä–µ–≤–æ', icon: 'üå≤', type: 'res' },
        'stone': { name: '–ö–∞–º–µ–Ω—å', icon: 'ü™®', type: 'res' },
        'iron': { name: '–ñ–µ–ª–µ–∑–æ', icon: '‚õìÔ∏è', type: 'res' },
        'fiber': { name: '–í–æ–ª–æ–∫–Ω–æ', icon: 'üß∂', type: 'res' },
        'meat': { name: '–°—ã—Ä–æ–µ –º—è—Å–æ', icon: 'ü•©', type: 'food', val: 10, poison: 5 },
        'meat_cooked': { name: '–°—Ç–µ–π–∫', icon: 'üçñ', type: 'food', val: 40 },
        'berry': { name: '–Ø–≥–æ–¥—ã', icon: 'üçí', type: 'food', val: 15, water: 10 },
        
        'axe': { name: '–¢–æ–ø–æ—Ä', icon: 'ü™ì', type: 'tool', slot: 'hand', speed: 2, desc: '–ë—ã—Å—Ç—Ä–æ —Ä—É–±–∏—Ç –¥–µ—Ä–µ–≤–æ' },
        'pick': { name: '–ö–∏—Ä–∫–∞', icon: '‚õèÔ∏è', type: 'tool', slot: 'hand', speed: 2, desc: '–õ–æ–º–∞–µ—Ç –∫–∞–º–Ω–∏' },
        'sword': { name: '–ö–∞—Ç–∞–Ω–∞', icon: '‚öîÔ∏è', type: 'weapon', slot: 'hand', dmg: 20, desc: '–û—Å—Ç—Ä—ã–π –∫–ª–∏–Ω–æ–∫' },
        
        'armor_l': { name: '–ö–æ–∂–∞–Ω–∫–∞', icon: 'üß•', type: 'armor', slot: 'chest', def: 10 },
        
        'wall': { name: '–°—Ç–µ–Ω–∞', icon: 'üß±', type: 'build', id: 10 },
        'floor': { name: '–ü–æ–ª', icon: '‚¨ú', type: 'build', id: 11 },
        'fire': { name: '–ö–æ—Å—Ç–µ—Ä', icon: 'üî•', type: 'build', id: 12 },
        'chest': { name: '–°—É–Ω–¥—É–∫', icon: 'üì¶', type: 'build', id: 13 }
    },
    recipes: [
        { id: 'axe', out: 'axe', n: 1, cost: { wood: 3, stone: 2 } },
        { id: 'pick', out: 'pick', n: 1, cost: { wood: 2, stone: 3 } },
        { id: 'sword', out: 'sword', n: 1, cost: { wood: 5, iron: 2 } },
        { id: 'armor_l', out: 'armor_l', n: 1, cost: { fiber: 10 } },
        { id: 'fire', out: 'fire', n: 1, cost: { wood: 10, stone: 5 } },
        { id: 'wall', out: 'wall', n: 1, cost: { wood: 5 } },
        { id: 'floor', out: 'floor', n: 1, cost: { wood: 2 } },
        { id: 'chest', out: 'chest', n: 1, cost: { wood: 15 } }
    ]
};

// --- CORE ENGINE ---
const Game = {
    canvas: document.getElementById('game'),
    ctx: document.getElementById('game').getContext('2d'),
    width: 0, height: 0,
    
    state: {
        camera: { x: 0, y: 0 },
        time: 720, // Minutes (12:00)
        daySpeed: 0.5, // 1 real sec = 0.5 game min
        mode: 'play', // play, build
        buildId: null
    },
    
    player: {
        x: 0, y: 0,
        hp: 100, food: 100, water: 100, temp: 100,
        inv: { 'wood': 5, 'berry': 2 }, // Starting items
        equip: { hand: null, chest: null },
        action: null,
        facing: 1
    },
    
    world: {
        seed: 123,
        chunks: {}, // Sparse map
        objects: [], // Interactive objects
        structures: [],
        animals: []
    },

    init() {
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.canvas.addEventListener('pointerdown', (e) => Input.handle(e));
        
        // Load or Gen
        if(!this.load()) this.genWorld();
        
        // Loop
        requestAnimationFrame(t => this.loop(t));
        setInterval(() => this.tick(), 1000);
    },

    resize() {
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        this.canvas.width = this.width;
        this.canvas.height = this.height;
        this.ctx.imageSmoothingEnabled = false;
    },

    genWorld() {
        // Procedural generation around 0,0
        for(let i=0; i<50; i++) {
            let x = (Math.random()*2000)-1000;
            let y = (Math.random()*2000)-1000;
            if(Math.random() > 0.3) this.world.objects.push({type:'tree', x, y, hp:3});
            else this.world.objects.push({type:'rock', x, y, hp:3});
        }
        // Animals
        for(let i=0; i<10; i++) {
            this.world.animals.push({
                type: Math.random()>0.5?'boar':'rabbit', 
                x: (Math.random()*1000)-500, 
                y: (Math.random()*1000)-500,
                hp: 20, state: 'idle', timer: 0
            });
        }
    },

    tick() {
        // Time
        this.state.time += this.state.daySpeed;
        if(this.state.time >= 1440) this.state.time = 0;
        
        // Stats Decay
        this.player.food = Math.max(0, this.player.food - 0.2);
        this.player.water = Math.max(0, this.player.water - 0.3);
        
        // Temperature logic based on Time
        const hour = Math.floor(this.state.time / 60);
        const isNight = hour < 6 || hour > 20;
        if(isNight && !this.player.equip.chest) {
            // Check fire nearby
            const nearFire = this.world.structures.some(s => s.id===12 && Math.hypot(s.x-this.player.x, s.y-this.player.y) < 150);
            if(!nearFire) this.player.temp = Math.max(0, this.player.temp - 2);
            else this.player.temp = Math.min(100, this.player.temp + 5);
        } else {
            this.player.temp = Math.min(100, this.player.temp + 1);
        }

        // Damage
        if(this.player.food===0 || this.player.water===0 || this.player.temp===0) this.player.hp -= 1;
        
        // AI Tick
        this.world.animals.forEach(a => AI.update(a));

        UI.updateHUD();
    },

    loop() {
        Physics.update();
        Renderer.draw();
        requestAnimationFrame(t => this.loop(t));
    },

    save() {
        const data = JSON.stringify({ p: this.player, w: this.world, s: this.state });
        localStorage.setItem('janus_v10', data);
    },

    load() {
        const d = localStorage.getItem('janus_v10');
        if(!d) return false;
        try {
            const parsed = JSON.parse(d);
            this.player = parsed.p;
            this.world = parsed.w;
            this.state = parsed.s;
            return true;
        } catch(e) { console.error(e); return false; }
    }
};

// --- INPUT & PHYSICS ---
const Input = {
    handle(e) {
        const r = Game.canvas.getBoundingClientRect();
        const mx = e.clientX - r.left + Game.state.camera.x;
        const my = e.clientY - r.top + Game.state.camera.y;

        if(Game.state.mode === 'build') {
            Game.state.mode = 'play';
            World.build(mx, my, Game.state.buildId);
            return;
        }

        // Check Click on Objects
        const obj = World.getAt(mx, my);
        if(obj) {
            Physics.setTarget(obj.x, obj.y, () => Interaction.interact(obj));
        } else {
            Physics.setTarget(mx, my);
        }
    }
};

const Physics = {
    target: null,
    
    setTarget(x, y, cb) {
        this.target = { x, y, cb };
        UI.fx(x, y, 'üìç');
    },

    update() {
        const p = Game.player;
        if(this.target) {
            const dx = this.target.x - p.x;
            const dy = this.target.y - p.y;
            const dist = Math.hypot(dx, dy);
            
            if(dist > 5) {
                const speed = 4;
                const vx = (dx/dist)*speed;
                const vy = (dy/dist)*speed;
                
                // Collision
                if(!World.isSolid(p.x + vx, p.y + vy)) {
                    p.x += vx;
                    p.y += vy;
                    p.facing = dx > 0 ? 1 : -1;
                } else {
                    this.target = null; // Stop at wall
                }
            } else {
                if(this.target.cb) this.target.cb();
                this.target = null;
            }
        }
    }
};

const Interaction = {
    interact(obj) {
        // Determine Tool Speed
        let speed = 2000;
        const hand = Game.player.equip.hand;
        
        if(obj.type === 'tree') {
            if(hand === 'axe') speed = 500;
            this.startAction('–†—É–±–∫–∞...', speed, () => {
                World.remove(obj);
                Inv.add('wood', 3);
                if(Math.random()>0.5) Inv.add('berry', 1);
                UI.toast('+3 –î–µ—Ä–µ–≤–∞');
            });
        }
        else if (obj.type === 'rock') {
            if(hand === 'pick') speed = 500;
            this.startAction('–î–æ–±—ã—á–∞...', speed, () => {
                World.remove(obj);
                Inv.add('stone', 2);
                if(Math.random()>0.3) Inv.add('iron', 1);
                UI.toast('+–ö–∞–º–µ–Ω—å');
            });
        }
        else if (obj.type === 'animal') {
            const dmg = hand === 'sword' ? 20 : 5;
            obj.hp -= dmg;
            UI.fx(obj.x, obj.y, `-${dmg}`);
            if(obj.hp <= 0) {
                World.remove(obj);
                Inv.add('meat', 1);
                UI.toast('–î–æ–±—ã—á–∞ –ø–æ–ª—É—á–µ–Ω–∞');
            }
        }
        else if (obj.type === 'structure' && obj.id === 13) {
            UI.toast('–°—É–Ω–¥—É–∫ –æ—Ç–∫—Ä—ã—Ç (WIP)');
        }
    },

    startAction(label, time, cb) {
        UI.toast(label);
        // Simple delay for prototype, normally visual bar
        setTimeout(cb, time);
    }
};

// --- WORLD LOGIC ---
const World = {
    getAt(x, y) {
        // Priority: Animal > Structure > Object
        const range = 30;
        const anim = Game.world.animals.find(a => Math.hypot(a.x-x, a.y-y) < range);
        if(anim) return {...anim, type:'animal', ref:anim};
        
        const struc = Game.world.structures.find(s => Math.hypot(s.x-x, s.y-y) < range);
        if(struc) return {...struc, type:'structure', ref:struc};
        
        const obj = Game.world.objects.find(o => Math.hypot(o.x-x, o.y-y) < range);
        if(obj) return {...obj, ref:obj};
        
        return null;
    },

    isSolid(x, y) {
        return Game.world.structures.some(s => s.id === 10 && Math.hypot(s.x-x, s.y-y) < 20);
    },

    build(x, y, id) {
        // Grid Snap
        const gx = Math.floor(x/48)*48 + 24;
        const gy = Math.floor(y/48)*48 + 24;
        
        if(this.isSolid(gx, gy)) { UI.toast('–ó–∞–Ω—è—Ç–æ!'); return; }
        
        if(Inv.has(Game.state.buildId)) {
            // Remove resources (simplified logic: items remove self on craft, buildings use item)
            // Wait, building usually consumes item from inv? Yes.
            Inv.remove(Game.state.buildId, 1);
            Game.world.structures.push({x: gx, y: gy, id: DB.items[Game.state.buildId].id});
            UI.toast('–ü–æ—Å—Ç—Ä–æ–µ–Ω–æ');
        }
    },

    remove(obj) {
        if(obj.type === 'animal') {
            Game.world.animals = Game.world.animals.filter(a => a !== obj.ref);
        } else {
            Game.world.objects = Game.world.objects.filter(o => o !== obj.ref);
        }
    }
};

const AI = {
    update(a) {
        if(Math.random() < 0.02) {
            a.tx = a.x + (Math.random()*200-100);
            a.ty = a.y + (Math.random()*200-100);
        }
        if(a.tx) {
            const dx = a.tx - a.x, dy = a.ty - a.y;
            const dist = Math.hypot(dx, dy);
            if(dist > 2) {
                a.x += (dx/dist);
                a.y += (dy/dist);
            } else { a.tx = null; }
        }
    }
};

// --- INVENTORY & CRAFT ---
const Inv = {
    add(id, n) {
        Game.player.inv[id] = (Game.player.inv[id]||0) + n;
        if(UI.activeTab === 'inv') UI.renderInv();
    },
    remove(id, n) {
        if((Game.player.inv[id]||0) >= n) {
            Game.player.inv[id] -= n;
            if(Game.player.inv[id]<=0) delete Game.player.inv[id];
            if(UI.activeTab === 'inv') UI.renderInv();
            if(UI.activeTab === 'craft') UI.renderCraft(); // Re-check costs
            return true;
        }
        return false;
    },
    has(id) { return (Game.player.inv[id]||0) > 0; }
};

// --- RENDERER ---
const Renderer = {
    draw() {
        const ctx = Game.ctx;
        const w = Game.width, h = Game.height;
        const cam = Game.state.camera;
        const p = Game.player;

        // Camera Follow
        cam.x += (p.x - w/2 - cam.x) * 0.1;
        cam.y += (p.y - h/2 - cam.y) * 0.1;

        // 1. GROUND
        ctx.fillStyle = '#1a2218'; // Dark Forest
        ctx.fillRect(0,0,w,h);
        
        // Grid Lines (Future style)
        ctx.strokeStyle = '#223322';
        ctx.lineWidth = 1;
        const offX = -cam.x % 48, offY = -cam.y % 48;
        ctx.beginPath();
        for(let x=offX; x<w; x+=48) { ctx.moveTo(x,0); ctx.lineTo(x,h); }
        for(let y=offY; y<h; y+=48) { ctx.moveTo(0,y); ctx.lineTo(w,y); }
        ctx.stroke();

        // 2. WORLD OBJECTS
        const list = [
            ...Game.world.objects.map(o => ({...o, z:o.y})),
            ...Game.world.structures.map(s => ({...s, type:'struct', z:s.y})),
            ...Game.world.animals.map(a => ({...a, type:'animal', z:a.y})),
            {...p, type:'player', z:p.y}
        ];
        list.sort((a,b) => a.z - b.z);

        list.forEach(o => {
            const x = o.x - cam.x;
            const y = o.y - cam.y;
            if(x<-50 || x>w+50 || y<-50 || y>h+50) return;

            if(o.type === 'player') this.drawPlayer(ctx, x, y, p);
            else if (o.type === 'animal') this.drawAnimal(ctx, x, y, o);
            else if (o.type === 'struct') this.drawStruct(ctx, x, y, o);
            else this.drawObj(ctx, x, y, o);
        });

        // 3. DAY/NIGHT CYCLE
        const hour = Game.state.time / 60;
        let darkness = 0;
        if(hour < 6) darkness = 0.7 - (hour/6)*0.2; // 0.7 to 0.5
        else if (hour > 18) darkness = 0.3 + ((hour-18)/6)*0.4; // 0.3 to 0.7
        else darkness = 0;
        
        if(darkness > 0) {
            ctx.fillStyle = `rgba(0,0,20,${darkness})`;
            ctx.fillRect(0,0,w,h);
            
            // Lights (Fire)
            Game.world.structures.forEach(s => {
                if(s.id === 12) {
                    const lx = s.x - cam.x, ly = s.y - cam.y;
                    const grad = ctx.createRadialGradient(lx, ly, 10, lx, ly, 150);
                    grad.addColorStop(0, 'rgba(255,200,50,0.6)');
                    grad.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = grad;
                    ctx.fillRect(lx-150, ly-150, 300, 300);
                }
            });
        }
    },

    drawPlayer(ctx, x, y, p) {
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(x, y+5, 15, 6, 0, 0, Math.PI*2); ctx.fill();
        
        // Body
        ctx.fillStyle = p.equip.chest ? '#353' : '#dcb'; // Armor or Skin
        ctx.fillRect(x-10, y-30, 20, 25);
        // Head
        ctx.fillStyle = '#dcb'; ctx.fillRect(x-10, y-50, 20, 20);
        // Legs
        ctx.fillStyle = '#223'; ctx.fillRect(x-8, y-5, 6, 15); ctx.fillRect(x+2, y-5, 6, 15);
        // Weapon
        if(p.equip.hand) {
            const icon = DB.items[p.equip.hand].icon;
            ctx.font = '20px serif';
            ctx.fillText(icon, x+12*p.facing, y-20);
        }
    },

    drawObj(ctx, x, y, o) {
        if(o.type === 'tree') {
            // Simple shadow tree
            ctx.fillStyle = '#111'; ctx.globalAlpha = 0.2; 
            ctx.beginPath(); ctx.ellipse(x+10, y, 20, 8, 0.5, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;

            ctx.font = '40px serif'; ctx.textAlign = 'center'; 
            ctx.fillText('üå≤', x, y);
        } else {
            ctx.font = '30px serif'; ctx.textAlign = 'center'; 
            ctx.fillText('ü™®', x, y);
        }
    },

    drawStruct(ctx, x, y, s) {
        ctx.font = '30px serif'; ctx.textAlign = 'center'; 
        const icon = Object.values(DB.items).find(i => i.id === s.id).icon;
        ctx.fillText(icon, x, y);
    },

    drawAnimal(ctx, x, y, a) {
        ctx.font = '24px serif'; ctx.textAlign = 'center'; 
        ctx.fillText(a.type==='boar'?'üêó':'üêá', x, y);
    }
};

// --- UI MANAGER ---
const UI = {
    activeTab: null,
    selectedItem: null,
    selectedRecipe: null,

    toggle(tab) {
        const win = document.getElementById('main-window');
        if(win.style.display === 'flex' && this.activeTab === tab) {
            this.close();
        } else {
            this.switchTab(tab);
        }
    },

    close() {
        document.getElementById('main-window').classList.remove('open');
        setTimeout(() => document.getElementById('main-window').style.display='none', 200);
        this.activeTab = null;
    },

    switchTab(tab) {
        this.activeTab = tab;
        const win = document.getElementById('main-window');
        win.style.display = 'flex';
        setTimeout(() => win.classList.add('open'), 10);

        // Tabs styling
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');

        // Views
        document.getElementById('view-inv').style.display = tab==='inv'?'block':'none';
        document.getElementById('view-craft').style.display = tab==='craft'?'block':'none';
        document.getElementById('inv-actions').style.display = 'none';
        document.getElementById('craft-actions').style.display = 'none';

        if(tab === 'inv') this.renderInv();
        if(tab === 'craft') this.renderCraft();
    },

    renderInv() {
        const g = document.getElementById('inv-grid');
        g.innerHTML = '';
        for(let k in Game.player.inv) {
            const count = Game.player.inv[k];
            const def = DB.items[k];
            const el = document.createElement('div');
            el.className = 'slot';
            el.innerHTML = `${def.icon}<span class="slot-count">${count}</span>`;
            el.onclick = () => this.selectItem(k);
            g.appendChild(el);
        }
    },

    selectItem(k) {
        this.selectedItem = k;
        const def = DB.items[k];
        document.getElementById('inv-actions').style.display = 'flex';
        document.getElementById('selected-item-name').innerText = def.name;
        
        const btn = document.getElementById('btn-use-item');
        if(def.type === 'food') {
            btn.innerText = '–°–™–ï–°–¢–¨';
            btn.onclick = () => { Inv.remove(k,1); Game.player.food+=def.val; this.toast('–í–∫—É—Å–Ω–æ'); this.renderInv(); };
        } else if (def.slot) {
            btn.innerText = '–≠–ö–ò–ü–ò–†–û–í–ê–¢–¨';
            btn.onclick = () => { Game.player.equip[def.slot]=k; this.toast('–ù–∞–¥–µ—Ç–æ'); };
        } else if (def.type === 'build') {
            btn.innerText = '–°–¢–†–û–ò–¢–¨';
            btn.onclick = () => { Game.state.mode='build'; Game.state.buildId=k; this.close(); this.toast('–†–µ–∂–∏–º —Å—Ç—Ä–æ–π–∫–∏'); };
        } else {
            btn.innerText = '-';
            btn.onclick = null;
        }
    },

    renderCraft() {
        const g = document.getElementById('craft-grid');
        g.innerHTML = '';
        DB.recipes.forEach(r => {
            const def = DB.items[r.out];
            const el = document.createElement('div');
            
            // Check Availability
            let can = true;
            for(let res in r.cost) if((Game.player.inv[res]||0) < r.cost[res]) can = false;
            
            el.className = `slot ${can ? 'available' : 'unavailable'}`;
            el.innerHTML = def.icon;
            el.onclick = () => this.selectRecipe(r, can);
            g.appendChild(el);
        });
    },

    selectRecipe(r, can) {
        this.selectedRecipe = r;
        const def = DB.items[r.out];
        document.getElementById('craft-actions').style.display = 'flex';
        document.getElementById('craft-name').innerText = def.name;
        
        // Show Cost
        const costDiv = document.getElementById('craft-cost');
        costDiv.innerHTML = '';
        for(let res in r.cost) {
            const has = Game.player.inv[res]||0;
            const need = r.cost[res];
            const span = document.createElement('span');
            span.className = has >= need ? 'ok' : 'missing';
            span.innerText = `${DB.items[res].icon} ${has}/${need}`;
            costDiv.appendChild(span);
        }

        const btn = document.getElementById('btn-do-craft');
        btn.disabled = !can;
        btn.onclick = () => {
            for(let res in r.cost) Inv.remove(res, r.cost[res]);
            Inv.add(r.out, r.n);
            this.toast(`–°–æ–∑–¥–∞–Ω–æ: ${def.name}`);
            this.renderCraft();
            this.selectRecipe(r, true); // Refresh UI
        };
    },

    updateHUD() {
        const p = Game.player;
        const set = (id, v) => document.getElementById(id).style.width = v + '%';
        set('hp-bar', p.hp); set('food-bar', p.food); set('water-bar', p.water); set('temp-bar', p.temp);
        
        const h = Math.floor(Game.state.time/60).toString().padStart(2,'0');
        const m = Math.floor(Game.state.time%60).toString().padStart(2,'0');
        document.getElementById('clock').innerText = `${h}:${m}`;
    },

    toast(msg) {
        const t = document.createElement('div'); t.className='toast'; t.innerText=msg;
        document.getElementById('toasts').appendChild(t);
        setTimeout(()=>t.remove(), 2000);
    },

    fx(x, y, txt) {
        // Floating text placeholder
    }
};

// Start
window.onload = () => Game.init();

</script>
</body>
</html>
