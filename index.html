<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JANUS: IMMERSION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --surface: #121212;
            --surface-2: #1e1e1e;
            --accent: #ffffff;
            --text: #eeeeee;
            --text-dim: #888888;
            --border: rgba(255,255,255,0.1);
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0; width: 100vw; height: 100dvh;
            background: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER (Fixed Top) */
        .status-bar {
            height: calc(60px + var(--safe-top));
            padding: var(--safe-top) 15px 10px 15px;
            background: rgba(18,18,18,0.95);
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; z-index: 10;
        }
        .char-name { font-weight: 700; font-size: 14px; }
        .res-val { font-family: 'JetBrains Mono'; font-weight: 700; font-size: 13px; color: #ffd700; }

        /* CHAT AREA (Scrollable Middle) */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 20px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –±–∞—Ä–∞ */
            display: flex; flex-direction: column; gap: 12px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .msg { max-width: 85%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.5; animation: pop 0.2s ease; }
        .msg.ai { background: var(--surface-2); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--accent); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; font-weight: 500; }
        .msg.system { align-self: center; font-size: 11px; color: var(--text-dim); border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px; }
        @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* BOTTOM DOCK (Fixed Bottom) */
        .bottom-dock {
            background: rgba(18,18,18,0.95);
            border-top: 1px solid var(--border);
            padding-bottom: var(--safe-bottom);
            flex-shrink: 0; z-index: 20;
        }

        .input-bar {
            padding: 10px 15px;
            display: flex; gap: 10px; align-items: center;
        }

        #main-input {
            flex: 1; background: #000; border: 1px solid var(--border);
            border-radius: 20px; padding: 10px 15px; color: #fff; font-size: 16px; /* 16px to prevent iOS zoom */
            outline: none;
        }
        #main-input:focus { border-color: #666; }

        .send-btn {
            width: 36px; height: 36px; border-radius: 50%; background: var(--accent);
            border: none; display: flex; justify-content: center; align-items: center; cursor: pointer;
        }

        .menu-grid { display: flex; justify-content: space-around; padding: 8px 0; border-top: 1px solid var(--border); }
        .menu-item { display: flex; flex-direction: column; align-items: center; gap: 3px; color: var(--text-dim); font-size: 9px; width: 60px; cursor: pointer; }
        .menu-icon { font-size: 18px; }

        /* PANELS */
        .sliding-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70vh;
            background: #151515; border-radius: 20px 20px 0 0; padding: 20px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000; display: flex; flex-direction: column;
        }
        .sliding-panel.open { transform: translateY(0); }
        .panel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .panel-overlay.visible { opacity: 1; pointer-events: auto; }

        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; overflow-y: auto; }
        .inv-slot { aspect-ratio: 1; background: #222; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 20px; border: 1px solid var(--border); }

        /* –ö–ù–û–ü–ö–ê –ó–ê–ö–†–´–¢–ò–Ø */
        .close-handle { width: 40px; height: 4px; background: #444; border-radius: 2px; align-self: center; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div>
            <div class="char-name" id="hud-name">...</div>
            <div style="font-size: 10px; color: #888;" id="hud-loc">...</div>
        </div>
        <div>
            <span class="res-val" id="hud-money">0</span> <span style="font-size: 9px; color: #888;">CR</span>
        </div>
    </div>

    <div id="chat-container"></div>

    <div class="bottom-dock">
        <div class="input-bar">
            <input type="text" id="main-input" placeholder="–î–µ–π—Å—Ç–≤–∏–µ..." autocomplete="off">
            <button class="send-btn" onclick="send()">‚û§</button>
        </div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openPanel('p-profile')"><div class="menu-icon">üë§</div>–ì–µ—Ä–æ–π</div>
            <div class="menu-item" onclick="openPanel('p-inv')"><div class="menu-icon">üéí</div>–°—É–º–∫–∞</div>
            <div class="menu-item" onclick="send('–û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è')"><div class="menu-icon">üëÅÔ∏è</div>–û—Å–º–æ—Ç—Ä</div>
            <div class="menu-item" onclick="openPanel('p-menu')"><div class="menu-icon">‚öôÔ∏è</div>–ú–µ–Ω—é</div>
        </div>
    </div>

    <div class="panel-overlay" id="overlay" onclick="closePanels()"></div>

    <div class="sliding-panel" id="p-profile">
        <div class="close-handle" onclick="closePanels()"></div>
        <h2 style="margin: 0 0 20px 0;">–î–æ—Å—å–µ</h2>
        <div style="font-size: 14px; color: #ccc;">
            <p>–ö–ª–∞—Å—Å: <span id="prof-class" style="color:#fff; font-weight:bold">...</span></p>
            <p>HP: <span id="prof-hp">100/100</span></p>
            <a href="https://hawkar-usls.github.io/iNaiHR-Janus-/" target="_blank" style="display:block; margin-top:20px; padding:12px; background:#222; text-align:center; color:#fff; text-decoration:none; border-radius:8px;">üß† –û—Ç–∫—Ä—ã—Ç—å iNaiHR</a>
        </div>
    </div>

    <div class="sliding-panel" id="p-inv">
        <div class="close-handle" onclick="closePanels()"></div>
        <h2 style="margin: 0 0 20px 0;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        <div class="inv-grid" id="inv-grid"></div>
    </div>

    <div class="sliding-panel" id="p-menu">
        <div class="close-handle" onclick="closePanels()"></div>
        <button onclick="send('–°—Ç–∞—Ç—É—Å'); closePanels()" style="width:100%; padding:15px; margin-bottom:10px; background:#222; border:1px solid #444; color:#fff; border-radius:8px;">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <button onclick="send('WIPE PROTOCOL'); closePanels()" style="width:100%; padding:15px; background:rgba(255,50,50,0.1); border:1px solid #f44; color:#f44; border-radius:8px;">–°–ë–†–û–° –ò–ì–†–´</button>
    </div>

<script>
    const API_BASE = "https://supperless-yoshiko-noneruditely.ngrok-free.dev";
    const USER_ID = window.Telegram.WebApp.initDataUnsafe?.user?.id || "392910542";
    
    const chat = document.getElementById('chat-container');
    const inp = document.getElementById('main-input');

    function addMsg(text, type) {
        const d = document.createElement('div');
        d.className = `msg ${type}`;
        d.innerHTML = text.replace(/\n/g, '<br>');
        chat.appendChild(d);
        // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
        setTimeout(() => chat.scrollTop = chat.scrollHeight, 50);
    }

    function openPanel(id) {
        document.getElementById('overlay').classList.add('visible');
        document.getElementById(id).classList.add('open');
    }
    function closePanels() {
        document.getElementById('overlay').classList.remove('visible');
        document.querySelectorAll('.sliding-panel').forEach(p => p.classList.remove('open'));
    }

    async function send(txt) {
        const text = txt || inp.value.trim();
        if(!text) return;
        
        if(!txt) inp.value = '';
        addMsg(text, 'user');

        try {
            const res = await fetch(`${API_BASE}/api/rpg/action`, {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'ngrok-skip-browser-warning':'true'},
                body: JSON.stringify({user_id: USER_ID, message: text})
            });
            const data = await res.json();
            
            if(data.text) {
                // –ß–∏—Å—Ç–∏–º —Ç–µ–∫—Å—Ç –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–µ–≥–æ–≤ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                let clean = data.text.replace('[–°–ò–°–¢–ï–ú–ê]', '').trim();
                addMsg(clean, 'ai');
            }
            if(data.hud_update) updateHUD(data.hud_update);
        } catch(e) {
            addMsg("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏...", "system");
        }
    }

    function updateHUD(d) {
        if(d.name) document.getElementById('hud-name').innerText = d.name;
        if(d.credits) document.getElementById('hud-money').innerText = d.credits;
        if(d.class_type) document.getElementById('prof-class').innerText = d.class_type;
        if(d.inv) {
            const grid = document.getElementById('inv-grid');
            grid.innerHTML = d.inv.length ? d.inv.map(i => `<div class="inv-slot" onclick="send('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ${i}')">üì¶<div style="font-size:9px">${i}</div></div>`).join('') : '<div style="color:#555">–ü—É—Å—Ç–æ</div>';
        }
    }

    inp.addEventListener('keypress', e => { if(e.key === 'Enter') send(); });
    
    // Auto-ping
    setTimeout(() => send('–°—Ç–∞—Ç—É—Å'), 500);
</script>
</body>
</html>
