<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POCKET SURVIVAL: PIXEL</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #111; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; }
        canvas { display: block; image-rendering: pixelated; }
        
        /* UI OVERLAY */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .panel { 
            background: rgba(20,20,20,0.9); border: 2px solid #444; 
            padding: 10px; pointer-events: auto; position: absolute; 
            color: #eee; font-size: 12px;
        }

        /* INVENTORY BAR */
        .hotbar {
            bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 5px;
        }
        .slot {
            width: 40px; height: 40px; background: #333; border: 2px solid #555;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            position: relative;
        }
        .slot.active { border-color: #f0a500; }
        .slot-icon { font-size: 20px; }

        /* EQUIPMENT MENU */
        .equip-menu {
            top: 20px; right: 20px; width: 120px; display: flex; flex-direction: column; gap: 5px;
        }
        .equip-btn {
            background: #333; color: white; border: 1px solid #666; padding: 5px; cursor: pointer; text-align: left;
        }
        .equip-btn:hover { background: #444; }

        .stat-bar { height: 4px; background: #333; margin-top: 2px; width: 100px; }
        .fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp .fill { background: #d00; }
    </style>
</head>
<body>

    <canvas id="game"></canvas>

    <div class="ui-layer">
        <div class="panel" style="top: 10px; left: 10px;">
            <div>HP <div class="stat-bar hp"><div class="fill" id="hp-val"></div></div></div>
            <div style="margin-top:5px; color:#aaa;" id="debug-info">X:0 Y:0</div>
        </div>

        <div class="panel equip-menu">
            <div style="color:#888; margin-bottom:5px;">–≠–ö–ò–ü–ò–†–û–í–ö–ê</div>
            <button class="equip-btn" onclick="equip('none')">–°–Ω—è—Ç—å –≤—Å—ë</button>
            <button class="equip-btn" onclick="equip('armor')">–ë—Ä–æ–Ω—è (–ö–µ–≤–ª–∞—Ä)</button>
            <div style="color:#888; margin:5px 0;">–û–†–£–ñ–ò–ï</div>
            <button class="equip-btn" onclick="equipWeapon('pistol')">–ü–∏—Å—Ç–æ–ª–µ—Ç</button>
            <button class="equip-btn" onclick="equipWeapon('rifle')">–í–∏–Ω—Ç–æ–≤–∫–∞ AR</button>
            <button class="equip-btn" onclick="equipWeapon('sword')">–ö–∞—Ç–∞–Ω–∞</button>
        </div>

        <div class="panel hotbar">
            <div class="slot active" onclick="setMode('move')"><span class="slot-icon">ü¶∂</span></div>
            <div class="slot" onclick="setMode('build')"><span class="slot-icon">üß±</span></div>
            <div class="slot" onclick="setMode('attack')"><span class="slot-icon">üéØ</span></div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    const SCALE = 3; // –ú–∞—Å—à—Ç–∞–± –ø–∏–∫—Å–µ–ª–µ–π
    const TILE = 16 * SCALE; // –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ –º–∏—Ä–∞
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    let camera = { x: 0, y: 0 };
    let mouse = { x: 0, y: 0 };
    let mode = 'move'; // move, build, attack

    // –ò–ì–†–û–ö
    const player = {
        x: 400,
        y: 300,
        vx: 0,
        vy: 0,
        speed: 3, // –ü–∏–∫—Å–µ–ª–µ–π –∑–∞ –∫–∞–¥—Ä
        target: null, // {x, y}
        facing: 1, // 1 = right, -1 = left
        animTimer: 0,
        state: 'idle', // idle, run
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞ (Paper Doll)
        equip: {
            body: 'skin', // skin
            chest: null,  // null, 'armor'
            weapon: null  // null, 'pistol', 'rifle', 'sword'
        }
    };

    // –û–±—ä–µ–∫—Ç—ã –º–∏—Ä–∞ (–¥–ª—è —Ç–µ—Å—Ç–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞)
    const objects = [];
    for(let i=0; i<20; i++) {
        objects.push({
            x: Math.random() * 2000, 
            y: Math.random() * 2000,
            type: Math.random() > 0.5 ? 'tree' : 'rock'
        });
    }

    function init() {
        resize();
        window.addEventListener('resize', resize);
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ú—ã—à—å / –¢–∞—á)
        canvas.addEventListener('pointerdown', handleInput);
        
        requestAnimationFrame(loop);
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.imageSmoothingEnabled = false; // –í–∞–∂–Ω–æ –¥–ª—è –ø–∏–∫—Å–µ–ª–µ–π!
    }

    function handleInput(e) {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left + camera.x;
        const my = e.clientY - rect.top + camera.y;

        if (mode === 'move') {
            player.target = { x: mx, y: my };
            // –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞
            effects.push({x: mx, y: my, time: 20});
        }
    }

    // --- GAME LOOP ---
    function loop() {
        update();
        render();
        requestAnimationFrame(loop);
    }

    function update() {
        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        if (player.target) {
            const dx = player.target.x - player.x;
            const dy = player.target.y - player.y;
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist > player.speed) {
                player.state = 'run';
                player.animTimer += 0.2;
                
                // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–∞
                const vx = (dx / dist) * player.speed;
                const vy = (dy / dist) * player.speed;

                player.x += vx;
                player.y += vy;

                // –ü–æ–≤–æ—Ä–æ—Ç —Å–ø—Ä–∞–π—Ç–∞
                if(vx > 0.1) player.facing = 1;
                if(vx < -0.1) player.facing = -1;
            } else {
                player.x = player.target.x;
                player.y = player.target.y;
                player.target = null;
                player.state = 'idle';
                player.animTimer = 0;
            }
        }

        // –ö–∞–º–µ—Ä–∞ (–ø–ª–∞–≤–Ω–æ–µ —Å–ª–µ–∂–µ–Ω–∏–µ)
        const targetCamX = player.x - canvas.width / 2;
        const targetCamY = player.y - canvas.height / 2;
        camera.x += (targetCamX - camera.x) * 0.1;
        camera.y += (targetCamY - camera.y) * 0.1;

        // UI Update
        document.getElementById('debug-info').innerText = `POS: ${Math.floor(player.x)}, ${Math.floor(player.y)}`;
    }

    // --- RENDER ENGINE ---
    function render() {
        // –§–æ–Ω
        ctx.fillStyle = '#2d2d2d';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –°–µ—Ç–∫–∞ –∑–µ–º–ª–∏ (–¥–ª—è –æ—â—É—â–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è)
        const gridSize = 50;
        const offsetX = -camera.x % gridSize;
        const offsetY = -camera.y % gridSize;
        
        ctx.beginPath();
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        for(let x=offsetX; x<canvas.width; x+=gridSize) {
            ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height);
        }
        for(let y=offsetY; y<canvas.height; y+=gridSize) {
            ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
        }
        ctx.stroke();

        // –†–µ–Ω–¥–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ Y –¥–ª—è –≥–ª—É–±–∏–Ω—ã)
        const renderList = [...objects, { ...player, type: 'player' }];
        renderList.sort((a, b) => a.y - b.y);

        renderList.forEach(obj => {
            const screenX = obj.x - camera.x;
            const screenY = obj.y - camera.y;

            if (obj.type === 'player') {
                drawPlayer(ctx, screenX, screenY);
            } else if (obj.type === 'tree') {
                drawTree(ctx, screenX, screenY);
            } else if (obj.type === 'rock') {
                drawRock(ctx, screenX, screenY);
            }
        });

        // –≠—Ñ—Ñ–µ–∫—Ç—ã
        renderEffects();
    }

    // --- PIXEL ART GENERATOR ---
    
    // –†–∏—Å—É–µ—Ç –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ "–ø–∏–∫—Å–µ–ª–µ–π"
    function rect(ctx, x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(Math.floor(x), Math.floor(y), w * SCALE, h * SCALE);
    }

    function drawPlayer(ctx, x, y) {
        const s = SCALE;
        const f = player.facing; // 1 –∏–ª–∏ -1
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è (bobbing)
        let bobY = 0;
        let legOffset = 0;
        
        if (player.state === 'run') {
            bobY = Math.sin(player.animTimer) * 1 * s;
            legOffset = Math.sin(player.animTimer * 2) * 3 * s;
        }

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –ø–æ –Ω–æ–≥–∞–º
        const cx = x;
        const cy = y - (12 * s); 

        ctx.save();
        
        // –û—Ç—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –µ—Å–ª–∏ —Å–º–æ—Ç—Ä–∏–º –≤–ª–µ–≤–æ
        if (f === -1) {
            ctx.translate(cx, cy);
            ctx.scale(-1, 1);
            ctx.translate(-cx, -cy);
        }

        // -- 1. –ù–û–ì–ò --
        const legColor = '#222'; // –®—Ç–∞–Ω—ã
        // –õ–µ–≤–∞—è –Ω–æ–≥–∞
        rect(ctx, cx - 2*s, cy + 8*s, 2, 4, legColor);
        // –ü—Ä–∞–≤–∞—è –Ω–æ–≥–∞ (–¥–≤–∏–≥–∞–µ—Ç—Å—è)
        rect(ctx, cx + 1*s + (legOffset/s), cy + 8*s, 2, 4, legColor);

        // -- 2. –¢–ï–õ–û --
        let chestColor = '#dcb18c'; // –ö–æ–∂–∞
        if (player.equip.chest === 'armor') chestColor = '#3a4a38'; // –í–æ–µ–Ω–Ω–∞—è –±—Ä–æ–Ω—è (–∑–µ–ª–µ–Ω–∞—è)
        
        // –¢–æ—Ä—Å
        rect(ctx, cx - 3*s, cy + 2*s + bobY, 6, 6, chestColor);
        
        // –ï—Å–ª–∏ –±—Ä–æ–Ω—è, —Ä–∏—Å—É–µ–º –¥–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç–∞
        if(player.equip.chest === 'armor') {
             rect(ctx, cx - 1*s, cy + 3*s + bobY, 2, 3, '#252e24'); // –ü–ª–∞—Å—Ç–∏–Ω–∞
        }

        // -- 3. –ì–û–õ–û–í–ê --
        const headY = cy - 4*s + bobY;
        rect(ctx, cx - 3*s, headY, 6, 6, '#dcb18c'); // –ö–æ–∂–∞
        // –í–æ–ª–æ—Å—ã / –®–ª–µ–º
        rect(ctx, cx - 3*s, headY, 6, 2, '#422'); // –¢–µ–º–Ω—ã–µ –≤–æ–ª–æ—Å—ã
        // –ì–ª–∞–∑–∞
        rect(ctx, cx + 1*s, headY + 2*s, 1, 1, '#000');

        // -- 4. –û–†–£–ñ–ò–ï (–°–ª–æ–π –Ω–∞–¥ —Ç–µ–ª–æ–º) --
        const handY = cy + 4*s + bobY;
        const handX = cx + 2*s;

        if (player.equip.weapon === 'pistol') {
            // –ü–∏—Å—Ç–æ–ª–µ—Ç (—á–µ—Ä–Ω—ã–π –±–ª–æ–∫)
            rect(ctx, handX, handY, 4, 2, '#111');
            rect(ctx, handX+1*s, handY+1*s, 1, 2, '#111'); // –†—É–∫–æ—è—Ç—å
        } 
        else if (player.equip.weapon === 'rifle') {
            // –í–∏–Ω—Ç–æ–≤–∫–∞ (–¥–ª–∏–Ω–Ω–∞—è)
            rect(ctx, handX - 2*s, handY, 10, 2, '#111'); // –°—Ç–≤–æ–ª
            rect(ctx, handX - 3*s, handY, 2, 3, '#533'); // –ü—Ä–∏–∫–ª–∞–¥ (–¥–µ—Ä–µ–≤–æ/–ø–ª–∞—Å—Ç–∏–∫)
            rect(ctx, handX + 1*s, handY+2*s, 1, 2, '#000'); // –ú–∞–≥–∞–∑–∏–Ω
        }
        else if (player.equip.weapon === 'sword') {
            // –ú–µ—á (–ø–æ–¥ —É–≥–ª–æ–º —Å–ª–æ–∂–Ω–æ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –±–µ–∑ —Ä–æ—Ç–∞—Ü–∏–∏ canvas, —Å–¥–µ–ª–∞–µ–º –ø—Ä—è–º—ã–º)
            rect(ctx, handX, handY - 8*s, 2, 10, '#ccc'); // –õ–µ–∑–≤–∏–µ
            rect(ctx, handX-1*s, handY, 4, 1, '#gold'); // –ì–∞—Ä–¥–∞
            rect(ctx, handX, handY + 1*s, 1, 2, '#533'); // –†—É–∫–æ—è—Ç—å
        }

        ctx.restore();
        
        // –ò–º—è/–°—Ç–∞—Ç—É—Å
        ctx.fillStyle = "white";
        ctx.font = "10px monospace";
        ctx.textAlign = "center";
        ctx.fillText("Survivor", x, y - 50);
    }

    // –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –¥–µ–∫–æ—Ä–∞—Ü–∏–∏
    function drawTree(ctx, x, y) {
        // –°—Ç–≤–æ–ª
        rect(ctx, x-2*SCALE, y-4*SCALE, 4, 4, '#533');
        // –õ–∏—Å—Ç–≤–∞ (–ø–∏—Ä–∞–º–∏–¥–∫–æ–π)
        rect(ctx, x-6*SCALE, y-14*SCALE, 12, 10, '#2d4e26');
        rect(ctx, x-4*SCALE, y-18*SCALE, 8, 4, '#3e6e36');
    }

    function drawRock(ctx, x, y) {
        rect(ctx, x-3*SCALE, y-3*SCALE, 6, 4, '#777');
        rect(ctx, x-2*SCALE, y-4*SCALE, 4, 1, '#888');
    }

    // --- EFFECTS ---
    let effects = [];
    function renderEffects() {
        ctx.strokeStyle = '#f0a500';
        ctx.lineWidth = 2;
        effects = effects.filter(e => e.time > 0);
        effects.forEach(e => {
            e.time--;
            const r = (20 - e.time) * 1.5;
            ctx.beginPath();
            ctx.arc(e.x - camera.x, e.y - camera.y, r, 0, Math.PI*2);
            ctx.stroke();
        });
    }

    // --- INTERFACE CONTROL ---
    window.equip = (type) => {
        if(type === 'none') {
            player.equip.chest = null;
        } else {
            player.equip.chest = type;
        }
    };

    window.equipWeapon = (type) => {
        player.equip.weapon = type;
    };

    window.setMode = (m) => {
        mode = m;
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
        event.currentTarget.classList.add('active');
    };

    init();
</script>
</body>
</html>
